# Task 1: X-ray analysis with MedGemma
xray_analysis_task:
  description: >
    Analyze the X-ray image at {image_url} using the 'xray_image_tool'.

    Your analysis should include:

    1. Identify visible pulmonary or thoracic anomalies
    2. For each anomaly found, describe:
       - Anatomical region (e.g., right mid-lung zone, left lower lobe)
       - Relative position (upper/middle/lower, medial/lateral)
       - Estimated size (small, medium, large)
       - Visual characteristics (mild opacity, consolidation, nodular, etc.)
    3. Evaluate visible normal structures (heart, mediastinum, diaphragm)
    4. Technical quality of the image

    RULES:
    - Focus only on medical visual interpretation
    - Be detailed in descriptions
    - Return ONLY valid JSON

  expected_output: >
    {{
      "anomaly_found": boolean,
      "anomalies": [
        {{
          "type": "string",
          "anatomical_region": "string",
          "position": "string",
          "size": "string",
          "visual_characteristics": "string",
          "confidence": float
        }}
      ],
      "normal_structures": "string",
      "image_quality": "string",
      "technical_description": "string"
    }}

  agent: xray_analyzer


# Task 2: Medical report writing
report_writing_task:
  description: >
    Based on the X-ray analysis provided by the previous agent, write a 
    formal and complete radiology report.

    The report should follow the standard structure:

    1. TECHNIQUE: Briefly describe the type of exam
    2. FINDINGS: List all relevant positive and negative findings
    3. IMPRESSION: Provide the most likely diagnosis with probability
    4. RECOMMENDATIONS: Suggest next steps if necessary

    RULES:
    - Use formal but clear medical language
    - Base strictly on the provided data
    - Assign probability as percentage (0-100)
    - Return ONLY valid JSON

  expected_output: >
    {{
      "technique": "string",
      "findings": "string",
      "impression": {{
        "diagnosis": "string",
        "probability_percentage": integer,
        "differential_diagnosis": ["string"]
      }},
      "recommendations": "string",
      "full_report": "string"
    }}

  agent: report_writer


# Task 3: Circle anomaly and save image
annotate_image_task:
  description: >
    Use the 'xray_anomaly_locator' tool to automatically locate and circle 
    anomalies in the X-ray image.

    Image: {image_url}

    Instructions:
    1. Execute the tool passing the image path
    2. The tool will:
       - Automatically detect pathologies using AI
       - Circle anomaly regions on the original image
       - Save the annotated image
    3. Return the saved image path and detection information

    IMPORTANT:
    - The tool automatically detects: Pneumonia, Mass, Consolidation, 
      Cardiomegaly, Edema, Effusion, Emphysema, Fibrosis, etc.
    - If no significant anomaly is detected (probability < 60%), 
      the tool will return anomaly_found: false

  expected_output: >
    {{
      "annotated_image_path": "string",
      "pathologies_detected": [
        {{
          "pathology": "string",
          "probability": float
        }}
      ],
      "anomaly_found": boolean
    }}

  agent: image_annotator

write_report_task:
  description: >
    Based on the previous X-ray analysis and the detected anomalies (including the annotated image), write a clear, concise, and comprehensive medical report.

    The report MUST include:
    1. Summary of findings (from the analysis)
    2. Detailed description of the detected anomaly/anomalies, including location, type, size, and visual characteristics
    3. Most likely diagnosis and differential diagnoses
    4. Recommendations for further evaluation or treatment
    5. Path to the original image, the annotated image and the heatmap image (with circles)
    6. A visual comparison section describing the difference between the original and annotated images

    RULES:
    - Use clear, objective, and formal medical language
    - Base the report strictly on the provided analysis and detected anomalies
    - Include the image paths in the output JSON
    - Return ONLY valid JSON

  expected_output: >
    {{
      "summary": "string",
      "anomaly_description": "string",
      "diagnosis": {{
        "main": "string",
        "differential": ["string"]
      }},
      "recommendations": "string",
      "original_image_path": "string",
      "annotated_image_path": "string",
      "heatmap_image_path": "string",
      "visual_comparison": "string"
    }}

  agent: redator
  context:
    - report_writing_task
    - annotate_image_task

show_report_docx:
  description: >
    Convert the final report (in JSON format) into a well-structured DOCX document using the tool "write_docx_tool".

    Instructions:
    1. Take the final report JSON output from the previous task
    2. Create a DOCX document with the following structure:
       - Title: "Radiology Report"
       - Sections:
         - Summary
         - Anomaly Description
         - Diagnosis (Main and Differential)
         - Recommendations
         - Image Paths (heatmap_image_path, annotated_image_path images)
           *!IMPORTANT: The markdown tag '![alt text](url)' MUST be placed on a completely new, empty line below its description.*
         - Visual Comparison
    3. Format the document for clarity and professionalism

    RULES:
    - Use clear formatting (headings, bullet points, etc.)
    - Include all relevant information from the JSON report
    - Return the path to the generated DOCX file
    - Use '#' for headings (e.g., '# Title', '## Subtitle')
    - Use '![alt text](url)' for inserting images.

  expected_output: >
    Return the path to the generated DOCX file in the following JSON format:
    {{
      "sucess": boolean
      "docx_path": "string",
    }}

  agent: report_writer
  context:
    - write_report_task